<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header">
    <h1>Commerce Analytics Dashboard</h1>
    <div class="header-actions">
      <mat-form-field appearance="outline">
        <mat-label>Date Range</mat-label>
        <mat-select value="30days" (selectionChange)="onDateRangeChange($event.value)">
          <mat-option value="7days">Last 7 days</mat-option>
          <mat-option value="30days">Last 30 days</mat-option>
          <mat-option value="90days">Last 90 days</mat-option>
        </mat-select>
      </mat-form-field>
      <button mat-raised-button color="primary" (click)="refreshData()">
        <mat-icon>refresh</mat-icon>
        Refresh Data
      </button>
    </div>
  </div>

  <!-- Key Metrics Cards -->
  @if (dashboardMetrics$ | async; as metrics) {
  <div class="metrics-grid">
    <mat-card class="metric-card">
      <mat-card-header>
        <mat-card-title>Total Revenue</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="metric-value">{{ formatCurrency(metrics.totalRevenue) }}</div>
        <div class="metric-change positive">
          <mat-icon>trending_up</mat-icon>
          {{ formatPercentage(metrics.periodComparison.revenue) }}
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="metric-card">
      <mat-card-header>
        <mat-card-title>Total Orders</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="metric-value">{{ formatNumber(metrics.totalOrders) }}</div>
        <div class="metric-change positive">
          <mat-icon>trending_up</mat-icon>
          {{ formatPercentage(metrics.periodComparison.orders) }}
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="metric-card">
      <mat-card-header>
        <mat-card-title>Average Order Value</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="metric-value">{{ formatCurrency(metrics.averageOrderValue) }}</div>
        <div class="metric-change neutral">
          <mat-icon>trending_flat</mat-icon>
          0.5%
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="metric-card">
      <mat-card-header>
        <mat-card-title>Conversion Rate</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="metric-value">{{ formatPercentage(metrics.conversionRate) }}</div>
        <div class="metric-change positive">
          <mat-icon>trending_up</mat-icon>
          2.1%
        </div>
      </mat-card-content>
    </mat-card>
  </div>
  }

  <!-- Charts Section -->
  <div class="charts-section">
    <div class="chart-row">
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Revenue Trend</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @if (revenueTimeSeries$ | async; as revenueData) {
          <app-virtualized-chart
            [data]="revenueData"
            [height]="300"
            chartType="line"
            title="Daily Revenue"
          >
          </app-virtualized-chart>
          }
        </mat-card-content>
      </mat-card>

      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Orders Trend</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @if (ordersTimeSeries$ | async; as ordersData) {
          <app-virtualized-chart
            [data]="ordersData"
            [height]="300"
            chartType="line"
            title="Daily Orders"
          >
          </app-virtualized-chart>
          }
        </mat-card-content>
      </mat-card>
    </div>

    <div class="chart-row">
      <mat-card class="chart-card wide">
        <mat-card-header>
          <mat-card-title>Product Performance</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @if (productMetrics$ | async; as products) {
          <div class="product-metrics-table">
            <div class="table-header">
              <span>Product</span>
              <span>Revenue</span>
              <span>Orders</span>
              <span>AOV</span>
              <span>Conv. Rate</span>
            </div>
            @for (product of products.slice(0, 10); track product.productId) {
            <div class="table-row">
              <span class="product-name">{{ product.name }}</span>
              <span>{{ formatCurrency(product.totalRevenue) }}</span>
              <span>{{ formatNumber(product.totalOrders) }}</span>
              <span>{{ formatCurrency(product.averageOrderValue) }}</span>
              <span>{{ formatPercentage(product.conversionRate) }}</span>
            </div>
            }
          </div>
          }
        </mat-card-content>
      </mat-card>
    </div>

    <div class="chart-row">
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Regional Performance</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @if (regionalPerformance$ | async; as regions) {
          <div class="regional-metrics">
            @for (region of regions; track region.region) {
            <div class="region-item">
              <div class="region-header">
                <span class="region-name">{{ region.region }}</span>
                <span
                  class="region-growth"
                  [class.positive]="region.growthRate > 0"
                  [class.negative]="region.growthRate < 0"
                >
                  {{ formatPercentage(region.growthRate) }}
                </span>
              </div>
              <div class="region-stats">
                <div class="stat">
                  <span class="stat-label">Revenue</span>
                  <span class="stat-value">{{ formatCurrency(region.revenue) }}</span>
                </div>
                <div class="stat">
                  <span class="stat-label">Orders</span>
                  <span class="stat-value">{{ formatNumber(region.orders) }}</span>
                </div>
              </div>
            </div>
            }
          </div>
          }
        </mat-card-content>
      </mat-card>

      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Customer Segments</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          @if (customerSegments$ | async; as segments) {
          <div class="customer-segments">
            @for (segment of segments; track segment.segmentId) {
            <div class="segment-item">
              <div class="segment-header">
                <span class="segment-name">{{ segment.name }}</span>
                <span class="segment-count"
                  >{{ formatNumber(segment.customerCount) }} customers</span
                >
              </div>
              <div class="segment-metrics">
                <div class="segment-metric">
                  <span class="metric-label">LTV</span>
                  <span class="metric-value">{{
                    formatCurrency(segment.averageLifetimeValue)
                  }}</span>
                </div>
                <div class="segment-metric">
                  <span class="metric-label">Retention</span>
                  <span class="metric-value">{{ formatPercentage(segment.retentionRate) }}</span>
                </div>
              </div>
              <mat-progress-bar
                [value]="segment.retentionRate * 100"
                mode="determinate"
                class="retention-bar"
              >
              </mat-progress-bar>
            </div>
            }
          </div>
          }
        </mat-card-content>
      </mat-card>
    </div>
  </div>
</div>
